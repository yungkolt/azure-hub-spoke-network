name: Validate Infrastructure Code

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-scripts:
    runs-on: ubuntu-latest
    name: Validate Bash Scripts
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
    
    - name: Validate deployment scripts
      run: |
        echo "ğŸ” Checking deployment scripts..."
        find deployment/scripts -name "*.sh" -exec shellcheck -x {} \; || true
        
    - name: Validate test scripts
      run: |
        echo "ğŸ” Checking test scripts..."
        find testing -name "*.sh" -exec shellcheck -x {} \; || true
        shellcheck test-deployment.sh || true

  validate-json:
    runs-on: ubuntu-latest
    name: Validate JSON Files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate JSON syntax
      run: |
        echo "ğŸ” Validating JSON files..."
        find . -name "*.json" -type f | while read -r file; do
          echo "Checking $file..."
          python3 -m json.tool "$file" > /dev/null && echo "âœ… $file is valid" || echo "âŒ $file has syntax errors"
        done

  validate-markdown:
    runs-on: ubuntu-latest
    name: Validate Documentation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check README links
      run: |
        echo "ğŸ” Checking documentation..."
        # Check if key files exist
        test -f README.md && echo "âœ… README.md exists" || echo "âŒ README.md missing"
        test -f LICENSE && echo "âœ… LICENSE exists" || echo "âŒ LICENSE missing"
        test -f docs/deployment/step-by-step-guide.md && echo "âœ… Deployment guide exists" || echo "âŒ Deployment guide missing"
        test -f monitoring/queries/network-analytics.kql && echo "âœ… KQL queries exist" || echo "âŒ KQL queries missing"

  validate-arm-template-syntax:
    runs-on: ubuntu-latest
    name: Validate ARM Template Syntax
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate ARM template syntax
      run: |
        echo "ğŸ” Validating ARM template syntax..."
        # Simple JSON validation for ARM template
        python3 -m json.tool deployment/arm-templates/main.json > /dev/null && echo "âœ… ARM template JSON is valid" || echo "âŒ ARM template has JSON syntax errors"
        
        # Check for required ARM template properties
        if grep -q '"$schema"' deployment/arm-templates/main.json; then
          echo "âœ… ARM template has schema"
        else
          echo "âŒ ARM template missing schema"
        fi
        
        if grep -q '"contentVersion"' deployment/arm-templates/main.json; then
          echo "âœ… ARM template has contentVersion"
        else
          echo "âŒ ARM template missing contentVersion"
        fi

  validate-monitoring:
    runs-on: ubuntu-latest
    name: Validate Monitoring Configuration
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check KQL query syntax
      run: |
        echo "ğŸ” Validating KQL queries..."
        if test -f monitoring/queries/network-analytics.kql; then
          echo "âœ… KQL queries file exists"
          # Basic KQL syntax check
          if grep -q "AzureNetworkAnalytics_CL" monitoring/queries/network-analytics.kql; then
            echo "âœ… KQL queries contain network analytics"
          fi
          if grep -q "AzureDiagnostics" monitoring/queries/network-analytics.kql; then
            echo "âœ… KQL queries contain diagnostic data"
          fi
        else
          echo "âŒ KQL queries file missing"
        fi

  project-structure-check:
    runs-on: ubuntu-latest
    name: Validate Project Structure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check project structure
      run: |
        echo "ğŸ” Validating project structure..."
        
        # Check required directories
        test -d deployment/scripts && echo "âœ… deployment/scripts exists" || echo "âŒ deployment/scripts missing"
        test -d deployment/arm-templates && echo "âœ… deployment/arm-templates exists" || echo "âŒ deployment/arm-templates missing"
        test -d testing && echo "âœ… testing directory exists" || echo "âŒ testing directory missing"
        test -d monitoring && echo "âœ… monitoring directory exists" || echo "âŒ monitoring directory missing"
        test -d docs && echo "âœ… docs directory exists" || echo "âŒ docs directory missing"
        
        # Check required files
        test -f deployment/scripts/deploy.sh && echo "âœ… Main deployment script exists" || echo "âŒ Main deployment script missing"
        test -f testing/connectivity-tests.sh && echo "âœ… Connectivity tests exist" || echo "âŒ Connectivity tests missing"
        test -f test-deployment.sh && echo "âœ… Test deployment script exists" || echo "âŒ Test deployment script missing"
        
        # Check script permissions (should be executable)
        if test -x deployment/scripts/deploy.sh; then
          echo "âœ… Deploy script is executable"
        else
          echo "âš ï¸ Deploy script may not be executable (run chmod +x)"
        fi
